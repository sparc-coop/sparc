@page "/store/{ProductId}"
@using Sparc.Engine.Aura
@layout CatalogLayout

<article class="product-page @(ActiveTab != null ? "left-only" : "")">
    <div class="page-container">
        <div class="left">
            <div class="left-container">
                @if (ActiveProduct != null)
                {
                    switch (ActiveTab)
                    {
                        case "Purchase":
                            <Sparc2.Catalog.ProductPurchase Product="ActiveProduct" />
                            ;
                            break;
                        case "Download":
                            <Sparc2.Catalog.ProductKey />
                            break;
                        case "Demo":
                        case "Help":
                        case null:
                            <Sparc2.Catalog.ProductImages Product="ActiveProduct" />
                            break;
                    }
                }
            </div>
        </div>
        <div class="right @((showFullDescription && ActiveTab == null) ? "fullscreen" : "")">
            <div class="right-container">
                <div class="right-header">
                    <button @onclick=@GoBack><ArrowLeftIcon /></button>
                </div>
                @if (ActiveProduct != null)
                {
                    <Sparc2.Catalog.ProductInfo PageType="Product" ActiveProduct="ActiveProduct" User="User" OnTabChanged="ChangeTab" />
                } 
                else
                {
                    <div class="product-info">
                        <header>
                            <h3>Select a product</h3>
                            <p>Hover over each product image to view more details</p>
                        </header>
                    </div>
                }
            </div>
        </div>
    </div>
</article>

@inject BlossomApi Api
@inject ISparcAura Aura
@code {
    [Parameter] public required string ProductId { get; set; }
    [SupplyParameterFromQuery(Name = "payment_intent_client_secret")] public string? PaymentIntentClientSecret { get; set; }
    [SupplyParameterFromQuery(Name = "paymentIntentId")] public string? PaymentIntentId { get; set; }

    Sparc.Blossom.Api.Product? ActiveProduct;
    BlossomUser User = null!; 
    bool showFullDescription;
    string? ActiveTab;

    protected override async Task OnInitializedAsync()
    {
        ActiveProduct = await Api.Products.Get(ProductId);
        User = await Aura.UserInfo();
        // if (PaymentIntentClientSecret != null)
        //     ToggleDownload();

    }

    void ChangeTab(string? tab)
    {
        ActiveTab = tab;
        showFullDescription = false;
    }

    void GoBack()
    {
        if (ActiveTab != null)
        {
            ActiveTab = null;
        }
        else
        {
            var url = "/store";
            Nav.NavigateTo(url);
        }
    }

    void ToggleFullDescription(bool showMore)
    {
        if (showMore)
        {
            showFullDescription = true;
            Js.InvokeVoidAsync("disableBodyScrolling");
        } else
        {
            showFullDescription = false;
        }
    }
}