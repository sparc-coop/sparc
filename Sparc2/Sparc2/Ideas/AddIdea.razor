@if (CurrentStep == 0)
{
    <header>
        <h2>Be Part of Sparc</h2>
        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,</p>
    </header>
    <EditForm EditContext="@EditContext">
        <label>
            <span>Title <span class="required">*</span></span>
            <InputText placeholder="Name your contribution" @bind-Value="Idea.Title" />
        </label>
        <label>
            <span>Name <span class="required">*</span></span>
            <InputText placeholder="Preferred name" @bind-Value="Idea.Author" />
        </label>
        <label>
            <span>Description</span>
            <InputTextArea placeholder="Text" @bind-Value="Idea.Description" />
        </label>
    </EditForm>
}
else if (CurrentStep == 1)
{
    <EditForm EditContext="@EditContext">
        <section>
            <h3>Share files (Optional)</h3>
            <div>
                <div>
                    Upload Files
                    <InputFile OnChange="HandleFileSelection" multiple />
                </div>
            </div>            
        </section>

        <section>
            <h3>Uploaded list (@UploadedFiles.Count)</h3>
            <ul>
                @foreach (var file in UploadedFiles)
                {
                    <li>
                        <article>
                            <img src="images/image-03.png" alt="File Icon" />
                            <div>
                                <h2>@file.FileName</h2>
                                <p>@(file.FileSize / (1024 * 1024)) MB</p>
                            </div>
                            <button @onclick="() => Remove(file)">x</button>
                        </article>
                        <div class="progress-bar">
                            <div class="progress" style="width: @file.Progress%"></div>
                        </div>
                    </li>
                }
            </ul>
        </section>
    </EditForm>
}

@inject Sparc2.Databases.AzureBlob.AzureBlob AzureBlob

@code {
    [Parameter] public int CurrentStep { get; set; }
    [Parameter] public ProjectIdea Idea { get; set; } = new("", "", "", new());
    [Parameter] public EditContext EditContext { get; set; }
    [Parameter] public List<Sparc2.Files.FileUpload> UploadedFiles { get; set; }
    [Parameter] public EventCallback<List<Sparc2.Files.FileUpload>> OnFilesChanged { get; set; }  

    public async Task HandleFileSelection(InputFileChangeEventArgs e)
    {  
        foreach (var file in e.GetMultipleFiles())
        {
            var uploaded = new Sparc2.Files.FileUpload(
                file.Name,
                url: "",
                fileFormat: Path.GetExtension(file.Name)?.TrimStart('.') ?? "unknown",
                fileSize: (int)file.Size
            );

            UploadedFiles.Add(uploaded);
            StateHasChanged();

            var progress = new Progress<int>(percent =>
            {
                uploaded.Progress = percent;
                InvokeAsync(StateHasChanged);
            });

            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            uploaded.Url = await AzureBlob.UploadFileAsync("uploads", file.Name, stream, file.ContentType, progress);
            Idea.FileUrls.Add(uploaded.Url);
        }

        await OnFilesChanged.InvokeAsync(UploadedFiles);
    }

    private void Remove(Sparc2.Files.FileUpload file)
    {
        UploadedFiles.Remove(file);
        Idea.FileUrls.Remove(file.Url);
    }
}